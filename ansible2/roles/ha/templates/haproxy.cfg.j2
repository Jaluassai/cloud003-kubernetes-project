global
    log /dev/log local0
    maxconn 2048
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 10s
    timeout client 1m
    timeout server 1m

frontend k8s_api
    bind *:{{ haproxy_listen_port }}
    default_backend k8s_api_back

backend k8s_api_back
    mode tcp
    option tcp-check
{% for host in groups['masters'] %}
    server {{ host }} {{ hostvars[host].ip }}:{{ haproxy_backend_port }} check fall 3 rise 2
{% endfor %}
